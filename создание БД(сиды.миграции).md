# –ì–∞–π–¥ –ø–æ —Ä–∞–±–æ—Ç–µ —Å Sequelize ORM

## üöÄ –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –ø–∞–ø–∫—É –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª –≤ —ç—Ç–æ–π –ø–∞–ø–∫–µ
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:

```bash
npm init -y
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .gitignore:

```bash
npx gitignore node
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ESLint

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ESLint:

```bash
npm init @eslint/config
```

### 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫

```bash
npm i sequelize sequelize-cli pg pg-hstore
```

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.sequelizerc` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ –Ω–µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

```javascript
const path = require('path');

module.exports = {
  config: path.resolve('db', 'config', 'database.json'),
  'models-path': path.resolve('db', 'models'),
  'seeders-path': path.resolve('db', 'seeders'),
  'migrations-path': path.resolve('db', 'migrations'),
};
```

### 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Sequelize

```bash
npx sequelize init
```

### 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `db/config/database.json`
2. –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

```json
{
  "development": {
    "username": "–≤–∞—à_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    "password": "–≤–∞—à_–ø–∞—Ä–æ–ª—å",
    "database": "–Ω–∞–∑–≤–∞–Ω–∏–µ_–±–∞–∑—ã_–¥–∞–Ω–Ω—ã—Ö",
    "host": "127.0.0.1",
    "dialect": "postgres"
  }
}
```

### 8. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
npx sequelize db:create
```

## üìù –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –∏ –º–∏–≥—Ä–∞—Ü–∏–π

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ Student
npx sequelize-cli model:generate --name Student --attributes first_name:string,last_name:string,age:integer

# –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ Computer
npx sequelize-cli model:generate --name Computer --attributes model:string,owner_id:integer
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã Computers
2. –î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–ª—è owner_id:

```javascript
module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.createTable('Computers', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
      },
      model: {
        type: Sequelize.STRING,
      },
      owner_id: {
        type: Sequelize.INTEGER,
        references: {
          model: 'Students',
          key: 'id',
        },
        allowNull: false,
        onDelete: 'cascade',
      },
      createdAt: {
        allowNull: false,
        type: Sequelize.DATE,
      },
      updatedAt: {
        allowNull: false,
        type: Sequelize.DATE,
      },
    });
  },
  async down(queryInterface, Sequelize) {
    await queryInterface.dropTable('Computers');
  },
};
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
npx sequelize db:migrate
```

## üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤

–î–æ–±–∞–≤—å—Ç–µ –≤ package.json —Å–ª–µ–¥—É—é—â–∏–µ —Å–∫—Ä–∏–ø—Ç—ã:

```json
{
  "scripts": {
    "mig": "npx sequelize db:migrate:undo:all && npx sequelize db:migrate",
    "seed": "npx sequelize db:seed:all",
    "createDB": "npx sequelize db:create",
    "dropDB": "npx sequelize db:drop"
  }
}
```

## üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤—è–∑–µ–π –≤ –º–æ–¥–µ–ª—è—Ö

### 1. –í –º–æ–¥–µ–ª–∏ Computer

```javascript
const { Model } = require('sequelize');
module.exports = (sequelize, DataTypes) => {
  class Computer extends Model {
    static associate(models) {
      this.belongsTo(models.Student, { foreignKey: 'owner_id' });
    }
  }
  Computer.init(
    {
      model: DataTypes.STRING,
      owner_id: DataTypes.INTEGER,
    },
    {
      sequelize,
      modelName: 'Computer',
    }
  );
  return Computer;
};
```

### 2. –í –º–æ–¥–µ–ª–∏ Student

```javascript
const { Model } = require('sequelize');
module.exports = (sequelize, DataTypes) => {
  class Student extends Model {
    static associate(models) {
      this.hasMany(models.Computer, { foreignKey: 'owner_id' });
    }
  }
  Student.init(
    {
      first_name: DataTypes.STRING,
      last_name: DataTypes.STRING,
      age: DataTypes.INTEGER,
    },
    {
      sequelize,
      modelName: 'Student',
    }
  );
  return Student;
};
```

## üå± –†–∞–±–æ—Ç–∞ —Å —Å–∏–¥–∞–º–∏ (seeders)

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–¥–æ–≤

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–¥–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
npx sequelize-cli seed:generate --name StudentsSeed

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–¥–∞ –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤
npx sequelize-cli seed:generate --name ComputersSeed
```

### 2. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∏–¥–æ–≤ –¥–∞–Ω–Ω—ã–º–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ `db/seeders`
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏—Ö —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

```javascript
/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.bulkInsert(
      'Students',
      [
        {
          first_name: '–ë–∏–±–∞',
          last_name: '–ë–∏–±–∏–Ω',
          age: 15,
          date: new Date('1985-05-11'),
          createdAt: new Date(),
          updatedAt: new Date(),
        },
        {
          first_name: '–ë–æ–±–∞',
          last_name: '–ë–æ–±–∏–Ω',
          age: 45,
          createdAt: new Date(),
          updatedAt: new Date(),
        },
      ],
      {}
    );
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.bulkDelete('Students', null, {});
  },
};
```

```javascript
/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.bulkInsert(
      'Computers',
      [
        {
          model: 'Apple Pencel',
          owner_id: 1,
          createdAt: new Date(),
          updatedAt: new Date(),
        },
        {
          model: 'IChick',
          owner_id: 1,
          createdAt: new Date(),
          updatedAt: new Date(),
        },
        {
          model: 'Semens',
          owner_id: 2,
          createdAt: new Date(),
          updatedAt: new Date(),
        },
        {
          model: 'Nokia',
          owner_id: 2,
          createdAt: new Date(),
          updatedAt: new Date(),
        },
      ],
      {}
    );
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.bulkDelete('Computers', null, {});
  },
};
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∏–¥–æ–≤

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ —Å–∏–¥—ã
npx sequelize db:seed:all

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–∏–¥
npx sequelize db:seed --seed –∏–º—è_—Ñ–∞–π–ª–∞_—Å–∏–¥–∞.js
```

## üìö CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

### 1. –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (READ)

```javascript
const { Computer, Student } = require('./db/models');

// READ All
async function getAllStudents() {
  try {
    const response = await Student.findAll();
    const result = response.map((el) => el.get());
    console.log(result);
  } catch (error) {
    console.log(error);
  }
}

getAllStudents();

// READ ONE
async function getOneStudent(first_name) {
  try {
    const response = await Student.findOne({ where: { first_name } });
    const result = response.get();
    console.log(result);
  } catch (error) {
    console.log(error);
  }
}

getOneStudent('Cook');

// READ ONE BY ID
async function getStudentById(id) {
  try {
    const response = await Student.findByPk(id);
    const result = response.get();
    console.log(result);
  } catch (error) {
    console.log(error);
  }
}
getStudentById(1);

// READ ALL INCLUDE
async function getStudentsWithComputers() {
  try {
    const response = await Student.findAll({
      attributes: ['id', 'first_name', 'last_name', 'age'],
      include: {
        model: Computer,
        attributes: ['id', 'model'],
      },
    });
    const result = response.map((el) => el.get({ plain: true }));
    console.dir(result, { depth: null });
  } catch (error) {
    console.log(error);
  }
}

getStudentsWithComputers();

async function getComputersWithOwner() {
  try {
    const response = await Computer.findAll({
      attributes: ['id', 'model'],
      include: {
        model: Student,
        attributes: ['id', 'first_name', 'last_name', 'age'],
      },
    });
    const result = response.map((el) => el.get({ plain: true }));
    console.dir(result, { depth: null });
  } catch (error) {
    console.log(error);
  }
}

getComputersWithOwner();
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (CREATE)

```javascript
/// CREATE
async function createComputer(computer) {
  try {
    const response = await Computer.create(computer);
    const result = response.get();
    console.log(result);
  } catch (error) {
    console.log(error);
  }
}

createComputer({ model: 'Aser', owner_id: 2 });

// CREATE MANY
async function createSomeComputers(computers) {
  try {
    const response = await Computer.bulkCreate(computers);
    // const response = await Promise.all(
    //   computers.forEach((element) => {
    //     Computer.create(element);
    //   })
    // );
    const result = response.map((el) => el.get({ plain: true }));
    console.log(result);
  } catch (error) {
    console.log(error);
  }
}

createSomeComputers([
  { model: 'Asus', owner_id: 2 },
  { model: 'Ring', owner_id: 1 },
  { model: 'Lords', owner_id: 1 },
]);
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (UPDATE)

```javascript
// UPDATE-V1
async function updateStudentById(id) {
  try {
    const existingStudent = await Student.findByPk(id);
    if (!existingStudent) return 'No data';
    existingStudent.first_name = 'guchi main';
    existingStudent.age = 16;
    await existingStudent.save();
    console.log(existingStudent.get());
  } catch (error) {
    console.log(error);
  }
}

updateStudentById(1);

// UPDATE-V2
async function updateStudentByIdVersionTwo(id) {
  try {
    await Student.update(
      { last_name: 'LOVE JAVASCRIPT', age: 17 },
      { where: { id } }
    );
    const res = await getStudentById(id);
    console.log(res);
  } catch (error) {
    console.log(error);
  }
}

updateStudentByIdVersionTwo(1);
```

### 4. –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (DELETE)

```javascript
async function deleteStudentById(id) {
  try {
    await Student.destroy({ where: { id } });
  } catch (error) {
    console.log(error);
  }
}

deleteStudentById(1).then((data) => getAllStudents());
```

## üìñ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Sequelize](https://sequelize.org/)
- [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏—è–º](https://sequelize.org/docs/v6/other-topics/migrations/)
